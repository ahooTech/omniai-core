
services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: omniai_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    #volumes:
      #- postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  app:
    build: .
    ports:
      - "8000:8000"
    # âœ… Load ALL app config from .env â€” no duplication
    # âœ… DO NOT hardcode JWT_SECRET_KEY here!
    # ğŸ‘‡ CRITICAL: Use .env.test.docker so app connects to omniai_test
    env_file:
      - .env.test.docker   # â† This loads JWT_SECRET_KEY from your .env
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./src:/app/src
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/v1/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # Test service
  test:
    build:
      context: .
      args:
        INSTALL_DEV: "true"
    env_file:
      - .env.test.docker  
    depends_on:
      app:
        condition: service_healthy
    environment:
      # So psql/pg_isready/dropdb don't prompt for password
      PGPASSWORD: postgres
    command: >
      sh -c "
        echo 'â³ Waiting for DB...' &&
        pg_isready -h db -U postgres &&

        echo 'ğŸš€ Waiting for app health check...' &&
        timeout 30 sh -c 'while ! curl -s --fail http://app:8000/v1/health; do sleep 1; done' &&

        echo 'âœ… App is ready!' &&

        echo 'ğŸ” Running static analysis...' &&
        ruff check . &&
        mypy src/ &&
        bandit -r src/ -ll -x \"**/migrations/**,**/__pycache__/**\" &&
        safety check --full-report &&

        echo 'ğŸ§ª Running tests...' &&
        pytest -v --tb=short
      "

volumes:
  postgres_data: